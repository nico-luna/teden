{% extends 'users/base.html' %}
{% load static %}
{% load form_tags %}

{% block title %}Editar Producto{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'products/css/styles.css' %}">

<div class="container mt-5">
  <h2 class="mb-4 text-center">Editar producto</h2>

  <form method="post" enctype="multipart/form-data" class="card p-4 shadow-sm mx-auto" style="max-width: 600px;">
    {% csrf_token %}

    <div class="mb-3">
      <label for="{{ form.name.id_for_label }}" class="form-label">Nombre del producto</label>
      {{ form.name|add_class:"form-control" }}
    </div>

    <div class="mb-3">
      <label for="{{ form.description.id_for_label }}" class="form-label">Descripción</label>
      {{ form.description|add_class:"form-control" }}
    </div>

    <div class="mb-3">
      <label for="{{ form.price.id_for_label }}" class="form-label">Precio</label>
      {{ form.price|add_class:"form-control" }}
    </div>

    <div class="mb-3">
      <label for="{{ form.stock.id_for_label }}" class="form-label">Stock disponible</label>
      {{ form.stock|add_class:"form-control" }}
    </div>

    <div class="mb-3">
      <label for="{{ form.image.id_for_label }}" class="form-label">Imagen del producto</label>
      {{ form.image|add_class:"form-control" }}
      {% if product.image %}
        <div class="mt-2">
          <img src="{{ product.image.url }}" alt="Imagen actual" class="img-thumbnail" style="max-height: 200px;">
          <p class="mt-1 text-muted">Imagen actual</p>
        </div>
      {% endif %}
      </div>

      <div class="mb-4">
        <label class="form-label">Galería de archivos (imágenes y videos)</label>
        <div class="d-flex flex-wrap gap-3">
          {% for media in product.images.all|dictsort:"order" %}
            <div class="border rounded p-2 text-center" style="width:120px;">
              {% if media.image %}
                <img src="{{ media.image.url }}" alt="Imagen galería" class="img-thumbnail mb-2" style="width:100px; height:100px; object-fit:cover;">
              {% elif media.video %}
                <video style="width:100px; height:100px; object-fit:cover;" controls>
                  <source src="{{ media.video.url }}" type="video/mp4">
                </video>
              {% endif %}
              {% if media.is_header %}
                <span class="badge bg-warning text-dark">Destacado</span>
              {% else %}
                <form method="post" action="{% url 'set_header_image' media.id %}" style="display:inline;">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-sm btn-outline-warning mt-1">Destacar</button>
                </form>
              {% endif %}
              <form method="post" action="{% url 'delete_gallery_media' media.id %}" style="display:inline;">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-outline-danger mt-1">Eliminar</button>
              </form>
              <form method="post" action="{% url 'move_gallery_media' media.id 'up' %}" style="display:inline;">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-outline-secondary mt-1">↑</button>
              </form>
              <form method="post" action="{% url 'move_gallery_media' media.id 'down' %}" style="display:inline;">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-outline-secondary mt-1">↓</button>
              </form>
            </div>
          {% empty %}
            <span class="text-muted">No hay archivos en la galería.</span>
          {% endfor %}
        </div>
    </div>

    <div class="d-flex justify-content-between">
      <button type="submit" class="btn btn-primary">Guardar cambios</button>
      <a href="{% url 'inventory' %}" class="btn btn-secondary">Cancelar</a>
    </div>
  </form>
</div>
{% endblock %}