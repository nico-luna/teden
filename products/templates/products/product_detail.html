{% extends 'users/base.html' %}
{% block title %}Detalle de producto{% endblock %}
{% block content %}
<div class="container py-5">
  <div class="row g-5">
    <div class="col-md-6">
      <div class="card shadow-sm rounded-4">
        <div id="gallerySlider" class="carousel slide mb-3" data-bs-ride="carousel">
          <div class="carousel-inner">
            {% for media in product.images.all %}
              <div class="carousel-item {% if forloop.first %}active{% endif %}">
                {% if media.image %}
                  <img src="{{ media.image.url }}" class="d-block w-100 rounded-top-4" alt="{{ product.name }}" style="height:320px; object-fit:cover;">
                {% elif media.video %}
                  <video class="d-block w-100 rounded-top-4" style="height:320px; object-fit:cover;" controls>
                    <source src="{{ media.video.url }}" type="video/mp4">
                    Tu navegador no soporta el video.
                  </video>
                {% endif %}
              </div>
            {% empty %}
              <div class="carousel-item active">
                <img src="https://via.placeholder.com/600x320?text=Sin+galeria" class="d-block w-100 rounded-top-4" alt="Sin galería" style="height:320px; object-fit:cover;">
              </div>
            {% endfor %}
          </div>
          <button class="carousel-control-prev" type="button" data-bs-target="#gallerySlider" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Anterior</span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#gallerySlider" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Siguiente</span>
          </button>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <strong>Galería:</strong>
            <div class="d-flex flex-wrap gap-3 mt-2">
              {% for media in product.images.all %}
                {% if not media.is_header %}
                  {% if media.image %}
                    <img src="{{ media.image.url }}" alt="Imagen galería" class="rounded shadow" style="width:100px; height:100px; object-fit:cover;">
                  {% elif media.video %}
                    <video style="width:100px; height:100px; object-fit:cover;" controls>
                      <source src="{{ media.video.url }}" type="video/mp4">
                    </video>
                  {% endif %}
                {% endif %}
              {% empty %}
                <span class="text-muted">No hay archivos en la galería.</span>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card mb-4 shadow-sm">
        <div class="card-body">
          <h5 class="card-title">{{ product.name }}</h5>
          <span class="badge bg-success mb-2" style="font-size:1.1rem;">${{ product.price }} USD</span>
          <div class="mb-3">
            <strong>Descripción:</strong>
            <p class="mt-1">{{ product.description|default:"Sin descripción" }}</p>
          </div>
          {% if product.file %}
            <div class="mb-2">
              <strong>Archivo descargable:</strong>
              <span class="badge bg-info">{{ product.file.size|filesizeformat }}</span>
            </div>
          {% endif %}
          <div class="mb-2">
            <strong>Valoración:</strong>
            <span>⭐ {{ product.avg_rating|default:"-" }} / 5</span>
            <span class="text-muted">({{ product.reviews.count }} reseñas)</span>
          </div>
          <form action="{% url 'buy_product' product.id %}" method="post" class="mt-3">
            {% csrf_token %}
            <button type="submit" class="btn btn-lg btn-primary w-100">Comprar producto</button>
          </form>
          <form action="{% url 'add_to_cart' %}" method="post" class="mt-2">
            {% csrf_token %}
            <input type="hidden" name="product_id" value="{{ product.id }}">
            <button type="submit" class="btn btn-lg btn-success w-100">Agregar al carrito</button>
          </form>
        </div>
      </div>
    </div>
  </div>
  <div class="row mt-5">
    <div class="col-12">
      <h4 class="mb-4">Reseñas</h4>
      {% for review in product.reviews.all %}
        <div class="border rounded p-3 mb-2">
          <strong>{{ review.user.username }}</strong> - ⭐ {{ review.rating }}/5<br>
          <small class="text-muted">{{ review.created_at|date:"d/m/Y H:i" }}</small>
          <p>{{ review.comment }}</p>
        </div>
      {% empty %}
        <p class="text-muted">Aún no hay reseñas para este producto.</p>
      {% endfor %}
      {% if user.is_authenticated and has_completed_order %}
        <hr>
        <h5>Dejá tu reseña</h5>
        <form action="{% url 'add_review' product.id %}" method="post">
          {% csrf_token %}
          {{ form.as_p }}
          <button type="submit" class="btn btn-primary">Enviar</button>
        </form>
      {% elif user.is_authenticated %}
        <p class="text-muted">Solo quienes compraron este producto pueden dejar una reseña.</p>
      {% else %}
  <p><a href="{% url 'login' %}">Iniciá sesión</a> para dejar una reseña.</p>
      {% endif %}
      {% if user.is_authenticated and user.is_staff %}
        <hr>
        <h5>Administrar reseñas</h5>
        <form action="{% url 'delete_review' product.id %}" method="post">
          {% csrf_token %}
          <div class="form-group">
            <label for="review_id">Seleccioná una reseña para eliminar:</label>
            <select name="review_id" id="review_id" class="form-control">
              {% for review in product.reviews.all %}
                <option value="{{ review.id }}">{{ review.user.username }} - {{ review.rating }}/5</option>
              {% endfor %}
            </select>
          </div>
          <button type="submit" class="btn btn-danger">Eliminar Reseña</button>
        </form>
      {% endif %}
    </div>
  </div>
    </div>
  </div>
</div>
{% endblock %}