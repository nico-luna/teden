{% extends 'users/base.html' %}
{% include "partials/cart_modal.html" %}
{% load static %}
{% load form_tags %}

{% block content %}
<link rel="stylesheet" href="{% static 'products/css/styles.css' %}">

<div class="container mt-5">
  <h2 class="mb-4 text-center">Agregar nuevo producto</h2>

  <form method="post" enctype="multipart/form-data" class="card p-4 shadow-sm mx-auto" style="max-width: 600px;">
    {% csrf_token %}

    <div class="mb-4">
      <label for="{{ form.name.id_for_label }}" class="form-label fw-bold">Nombre del producto</label>
      {{ form.name|add_class:"form-control form-control-lg" }}
    </div>

    <div class="mb-4">
      <label for="{{ form.description.id_for_label }}" class="form-label fw-bold">Descripción</label>
      {{ form.description|add_class:"form-control" }}
    </div>

    <div class="mb-4">
      <label for="id_category" class="form-label fw-bold">Categoría</label>
      {{ form.category|add_class:"form-select" }}
    </div>

    <div class="row g-3">
      <div class="col-md-6 mb-4">
        <label for="{{ form.price.id_for_label }}" class="form-label fw-bold">Precio <span class="text-muted" style="font-size:0.95em;">(USD)</span></label>
        {{ form.price|add_class:"form-control" }}
      </div>
      <div class="col-md-6 mb-4">
        <label for="{{ form.stock.id_for_label }}" class="form-label fw-bold">Stock disponible</label>
        {{ form.stock|add_class:"form-control" }}
      </div>
    </div>

    <div class="mb-4">
      <label for="{{ form.file.id_for_label }}" class="form-label fw-bold">Archivo descargable</label>
      {{ form.file|add_class:"form-control" }}
      <small class="form-text text-muted">Permitidos: .pdf, .zip, .mp3, .wav (máx. 25MB)</small>
      <div id="filePreview" class="mt-2 text-secondary" style="display:none;"></div>
    </div>

    <div class="mb-4 text-center">
      <label for="{{ form.image.id_for_label }}" class="form-label fw-bold">Imagen del producto</label>
      {{ form.image|add_class:"form-control" }}
      <div class="mt-3">
        <img id="imagePreview" src="#" alt="Preview" class="rounded-4 shadow" style="max-width:220px; max-height:220px; display:none; object-fit:cover;">
      </div>
      </div>

      <div class="mb-4">
  <label for="id_gallery" class="form-label fw-bold">Galería de archivos (máx. 5)</label>
  <input type="file" name="gallery" id="id_gallery" class="form-control" accept="image/*,video/*" multiple>
  <small class="form-text text-muted">Podés subir hasta 5 imágenes o videos en total. El primer archivo será la cabecera destacada.</small>
  <div id="galleryPreview" class="row mt-3"></div>
  <small class="form-text text-muted">Arrastrá para reordenar los archivos antes de guardar.</small>
    </div>

    <div class="d-flex justify-content-between mt-4">
      <button type="submit" class="btn btn-success btn-lg px-4">Guardar producto</button>
      <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary btn-lg px-4">Cancelar</a>
    </div>
  </form>
</div>

<script>
  // Preview de imagen y galería con drag & drop
  document.addEventListener('DOMContentLoaded', function() {
    var imageInput = document.getElementById('{{ form.image.id_for_label }}');
    var imagePreview = document.getElementById('imagePreview');
    if(imageInput) {
      imageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if(file) {
          const reader = new FileReader();
          reader.onload = function(ev) {
            imagePreview.src = ev.target.result;
            imagePreview.style.display = 'inline-block';
          };
          reader.readAsDataURL(file);
        } else {
          imagePreview.style.display = 'none';
        }
      });
    }
    // Preview de archivo
    var fileInput = document.getElementById('{{ form.file.id_for_label }}');
    var filePreview = document.getElementById('filePreview');
    if(fileInput) {
      fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if(file) {
          filePreview.textContent = 'Archivo seleccionado: ' + file.name;
          filePreview.style.display = 'block';
        } else {
          filePreview.textContent = '';
          filePreview.style.display = 'none';
        }
      });
    }

    // Preview y drag & drop galería
    var galleryInput = document.getElementById('id_gallery');
    var galleryPreview = document.getElementById('galleryPreview');
    let galleryFiles = [];

    function renderGalleryPreview() {
      galleryPreview.innerHTML = '';
      galleryFiles.forEach(function(file, idx) {
        const reader = new FileReader();
        reader.onload = function(ev) {
          let col = document.createElement('div');
          col.className = 'col-4 mb-2';
          col.draggable = true;
          col.dataset.idx = idx;
          col.style.cursor = 'grab';
          col.addEventListener('dragstart', function(e) {
            e.dataTransfer.setData('text/plain', idx);
          });
          col.addEventListener('dragover', function(e) {
            e.preventDefault();
            col.classList.add('border-primary');
          });
          col.addEventListener('dragleave', function(e) {
            col.classList.remove('border-primary');
          });
          col.addEventListener('drop', function(e) {
            e.preventDefault();
            col.classList.remove('border-primary');
            const fromIdx = parseInt(e.dataTransfer.getData('text/plain'));
            const toIdx = idx;
            if(fromIdx !== toIdx) {
              const moved = galleryFiles.splice(fromIdx, 1)[0];
              galleryFiles.splice(toIdx, 0, moved);
              renderGalleryPreview();
            }
          });
          let preview;
          if(file.type.startsWith('image/')) {
            preview = document.createElement('img');
            preview.src = ev.target.result;
            preview.className = 'img-thumbnail';
            preview.style.maxHeight = '120px';
            preview.style.maxWidth = '100%';
          } else if(file.type.startsWith('video/')) {
            preview = document.createElement('video');
            preview.src = ev.target.result;
            preview.controls = true;
            preview.className = 'img-thumbnail';
            preview.style.maxHeight = '120px';
            preview.style.maxWidth = '100%';
          }
          let info = document.createElement('div');
          info.className = 'small text-center';
          info.textContent = file.name;
          col.appendChild(preview);
          col.appendChild(info);
          galleryPreview.appendChild(col);
        };
        reader.readAsDataURL(file);
      });
    }

    galleryInput.addEventListener('change', function(e) {
      galleryFiles = Array.from(e.target.files).slice(0,5);
      renderGalleryPreview();
    });
  });
</script>

{% if messages %}
  {% for message in messages %}
    {% if 'plan' in message.message %}
      <div class="modal fade" id="planLimitModal" tabindex="-1" aria-labelledby="planLimitModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="planLimitModalLabel">Límite de productos por plan</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
              <p>No podés agregar más productos porque alcanzaste el límite de tu plan actual.</p>
              <p>Para publicar más productos, actualizá tu plan TEDEN.</p>
            </div>
            <div class="modal-footer d-flex justify-content-between">
              <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">Volver al dashboard</a>
              <a href="{% url 'elegir_plan' %}" class="btn btn-primary">Actualizar plan</a>
            </div>
          </div>
        </div>
      </div>
      <script>
        document.addEventListener('DOMContentLoaded', function() {
          var modal = new bootstrap.Modal(document.getElementById('planLimitModal'));
          modal.show();
        });
      </script>
    {% endif %}
  {% endfor %}
{% endif %}
  </form>
</div>
{% endblock %}
